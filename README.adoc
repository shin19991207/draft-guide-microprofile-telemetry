// Copyright (c) 2025 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
// https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
// IBM Corporation
//
:page-layout: guide-multipane
:projectid: microprofile-telemetry
:page-duration: 45 minutes
:page-releasedate: 2025-06-01
:page-guide-category: microprofile
:page-essential: false
:page-description: Learn how to enable and customize the collection of traces, metrics, and logs from microservices using MicroProfile Telemetry.
:guide-author: Open Liberty
:page-tags: ['microprofile']
:page-permalink: /guides/{projectid}
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:page-related-guides: [ 'microprofile-telemetry-jaeger', 'microprofile-metrics', 'microprofile-health' ]
:imagesdir: /img/guide/{projectid}
:page-seo-title: Enhancing observability in Java microservices using MicroProfile Telemetry and the Grafana LGTM stack
:page-seo-description: A getting started tutorial on how to enable and customize the collection of traces, metrics, and logs from Java microservices by using MicroProfile Telemetry in Open Liberty and visualizing them with the OpenTelemetry-compatible Grafana LGTM stack.
:source-highlighter: prettify
= Enhancing observability in microservices with traces, metrics, and logs using OpenTelemetry

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Learn how to enable and customize the collection of traces, metrics, and logs from microservices using MicroProfile
Telemetry.

// =================================================================================================
//  What you'll learn
// =================================================================================================
== What you'll learn
The complexity of microservices architecture can make it more difficult to understand how services depend on or affect each other and to identify sources of latency or inaccuracies.

One way to increase the observability of an application is by emitting traces. https://opentelemetry.io/[OpenTelemetry^] is a set of APIs, SDKs, tooling, and integrations designed to create and manage telemetry data such as traces, metrics, and logs. MicroProfile Telemetry adopts OpenTelemetry so your Java applications can benefit from both manual and automatic traces.

Traces represent requests, which can contain multiple operations or spans. Each span comprises a name, time-related data, log messages, and metadata that describe what occurred during a transaction. Spans are associated with a context, which identifies the request within which the span occurred. Developers can then follow a single request between services through a potentially complex distributed system. Exporters send the data that MicroProfile Telemetry collects to Jaeger so you can visualize and monitor the generated spans.

The diagram shows multiple services, which is where distributed tracing is valuable. However, for simplicity, in this guide, you'll configure only the `inventory` and `system` services to use https://www.jaegertracing.io/[Jaeger^] for distributed tracing with MicroProfile Telemetry. You'll run these services in two separate JVMs made of two Open Liberty instances to demonstrate tracing in a distributed environment.

// image::architecture_diagram.png[Application architecture,align="center"]

// =================================================================================================
//  Additional prerequisites 
// =================================================================================================
== Additional prerequisites 

Before you begin, ensure that Docker is installed and running on your system. For installation instructions, see the https://docs.docker.com/get-started/get-docker/[official Docker documentation^]. You will use Docker to start the Grafana LGTM stack, which serves as the OpenTelemetry-compatible backend for collecting and visualizing telemetry data.

=== Setting up the Grafana LGTM stack

Start the Grafana LGTM stack by running the following Docker command:

[role="command"]
----
docker run -p 3000:3000 -p 4317:4317 -p 4318:4318 --rm -ti grafana/otel-lgtm
----

This container runs all the services needed for full observability—the OpenTelemetry Collector for receiving telemetry data, Loki for logs, Prometheus for metrics, Tempo for tracing, and Grafana for visualization—all preconfigured and running together.

Once the stack is up and running, you can access the Grafana dashboard at http://localhost:3000.

For more information about Grafana LGTM stack, see the container image on https://hub.docker.com/r/grafana/otel-lgtm[Docker Hub^] or the source code on https://github.com/grafana/docker-otel-lgtm[GitHub^].

// =================================================================================================
// Getting started
// =================================================================================================
[role='command']
include::{common-includes}/gitclone.adoc[]

=== Try what you'll build

The `finish` directory in the root of this guide contains the finished application. Give it a try before you proceed.

To try out the application, go to the `finish` directory and run the following Maven goal to build the `inventory` service and deploy it to Open Liberty:

[role="command"]
----
mvn -pl inventory liberty:run
----

Next, open another command-line session in the `finish` directory and run the following command to start the `system` service:

[role="command"]
----
mvn -pl system liberty:run
----

After you see the following message in both command-line sessions, both of your services are ready:

[role="no_copy"]
----
The defaultServer server is ready to run a smarter planet.
----


Navigate your browser to the http://localhost:9081/inventory/systems/localhost URL.

When you visit this endpoint, you make two GET HTTP requests, one to the ***system*** service and another to the ***inventory*** service. Both of these requests are configured to be traced, so a new trace is recorded in Jaeger. To view the traces, click the following button to visit the Jaeger service:

You can view the traces for the `system` or `inventory` services under the **Search** tab. If you see only the **jaeger-query** option in the drop-down menu, wait a little longer and refresh the page to see the application services.

Select the services in the **Select A Service** menu and click the **Find Traces** button at the end of the section. You will see the following result:

image::inventory_service_spans.png[Get traces for the inventory service,align="center"]


The trace has five spans, four from the `inventory` service and one from the `system` service. Click the trace to view its details. Under **Service & Operation**, you see the spans in this trace. You can inspect each span by clicking it to reveal more detailed information, such as the times that a request was received and a response was sent.

image::inventory_details_spans.png[Inventory details spans,align="center"]


After you're finished reviewing the application, stop the Open Liberty instances by pressing `CTRL+C` in the command-line sessions where you ran the `inventory` and `system` services. Alternatively, you can run the following goals from the `finish` directory in another command-line session:

[role="command"]
----
 mvn -pl inventory liberty:stop
 mvn -pl system liberty:stop
----

// =================================================================================================
// Enabling automatic Telemetry collection
// =================================================================================================
== Enabling automatic Telemetry collection

MicroProfile Telemetry can automatically collect telemetry data without requiring changes to your application code.

Navigate to the `start` directory to begin.

=== Enabling MicroProfile Telemetry

To collect and export telemetry data with OpenTelemetry, add the MicroProfile Telemetry feature to each service's `server.xml` file.

[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `server.xml` file of the inventory service:#
`inventory/src/main/liberty/config/server.xml`
----

inventory/server.xml
[source, xml, linenums, role='code_column hide_tags=thirdPartyComment,thirdParty']
----
include::finish/inventory/src/main/liberty/config/server.xml[]
----

The [hotspot=mpTelemetry file=0]`mpTelemetry` feature is added to enable MicroProfile Telemetry support in Open Liberty for the `inventory` service.

[role="code_command hotspot file=1", subs="quotes"]
----
#Replace the `server.xml` file of the system service:#
`system/src/main/liberty/config/server.xml`
----

system/server.xml
[source, xml, linenums, role='code_column']
----
include::finish/system/src/main/liberty/config/server.xml[]
----

Similarly, add the [hotspot=mpTelemetry file=1]`mpTelemetry` feature to the `system` service to enable MicroProfile Telemetry support for it.


=== Enabling telemetry collection

By default, MicroProfile Telemetry is disabled to minimize performance overhead. To enable it, create a `bootstrap.properties` file for each service and configure the necessary OpenTelemetry properties.

[role="code_command hotspot file=2", subs="quotes"]
----
#Create the `bootstrap.properties` file of the inventory service:#
`system/src/main/liberty/config/server.xml`
----

inventory/bootstrap.properties
[source, properties, linenums, role='code_column']
----
include::finish/inventory/src/main/liberty/config/bootstrap.properties[]
----

Set the [hotspot=disabled file=2]`otel.sdk.disabled=false` property in the https://openliberty.io/docs/latest/reference/bootstrap-properties.html[`bootstrap.properties`^] file to enable telemetry collection. Because this file applies configuration at the runtime level, it allows both runtime and application telemetry to be collected. If you instead configure this property at the application level, runtime telemetry will not be collected. See the https://openliberty.io/docs/latest/microprofile-telemetry.html#global[MicroProfile Telemetry configuration documentation^] for details.

The [hotspot=service file=2]`otel.service.name` property assigns a service name to the collected telemetry data, helping to identify its source in monitoring tools like Grafana.

The Grafana LGTM stack receives telemetry data via the OTLP protocol, which is the default for OpenTelemetry. Therefore, no additional exporter configuration is needed.

[role="code_command hotspot file=3", subs="quotes"]
----
#Create the `bootstrap.properties` file of the system service:#
`system/src/main/liberty/config/server.xml`
----

system/bootstrap.properties
[source, properties, linenums, role='code_column']
----
include::finish/system/src/main/liberty/config/bootstrap.properties[]
----

Similarly, configure the OpenTelemetry properties for the `system` service.

For more information about these and other Telemetry properties, see the https://openliberty.io/docs/latest/reference/microprofile-config-properties.html#telemetry[MicroProfile Config properties for MicroProfile Telemetry^] documentation.

=== Monitoring your microservices

You need to start the services to begin collecting telemetry data.

When you run Open Liberty in https://openliberty.io/docs/latest/development-mode.html[dev mode^], dev mode listens for file changes and automatically recompiles and deploys your updates whenever you save a new change. Run the following command to start the `inventory` service in dev mode:

[role="command"]
----
mvn -pl inventory liberty:dev
----

Open another command-line session and run the following command to start the `system` service in dev mode:

[role="command"]
----
mvn -pl system liberty:dev
----

After you see the following message, your Liberty instance is ready in dev mode:

[role="no_copy"]
----
**************************************************************
*    Liberty is running in dev mode.
----

Dev mode holds your command-line session to listen for file changes. Open another command-line session to continue, or open the project in your editor.

When the runtime instances start, you can find the `inventory` and `system` services at the following URLs:

* http://localhost:9081/inventory/systems
* http://localhost:9080/system/properties

To run the `inventory` and `system` services, simply navigate your browser to the http://localhost:9081/inventory/systems/localhost URL. 

To visualize the data, open the Grafana dashboard at http://localhost:3000.

From the Grafana homepage, navigate to the Explore view or Dashboards menu. Use the Tempo data source to search for traces, the Loki data source for logs, and Prometheus for metrics.

You can explore telemetry signals from the `inventory` and `system` services by searching for `otel.service.name` or by viewing specific metrics.

// =================================================================================================
// Testing the application 
// =================================================================================================
== Testing the application 

Manually verify the telemetry signals—logs, metrics, and traces—by inspecting them in the Grafana dashboard. You can also run the included tests to check the basic functionality of the services. If any of the tests fail, you might have introduced a bug into the code.

=== Running the tests

Since you started Open Liberty in dev mode, run the tests for the `inventory` and `system` services by pressing the `enter/return` key in the command-line sessions where you started the services.

When you are done checking out the services, exit dev mode by pressing `CTRL+C` in the shell sessions where you ran the `inventory` and `system` services.

Finally, stop the Grafana LGTM stack that you started in the **Additional prerequisites** section.

// =================================================================================================
// Great work! You're done!
// =================================================================================================

== Great work! You're done!

Try out one of the related MicroProfile guides. These guides demonstrate more technologies that you can learn to expand on what you built in this guide.

include::{common-includes}/attribution.adoc[subs="attributes"]
